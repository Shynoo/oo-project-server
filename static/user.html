<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>User - Library</title>
    <link rel="stylesheet" href="bootstrap.min.css">
    <link rel="stylesheet" href="mdl/material.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="mdl/material.min.js"></script>
    <script src="jquery.min.js"></script>
    <script src="bootstrap.min.js"></script>
    <script src="js.cookie.js"></script>
    <link rel="stylesheet" href="common.css">
    <link href='https://fonts.googleapis.com/css?family=Product+Sans:400,400i,700,700i' rel='stylesheet' type='text/css'>
    <style>
        input.form-control {
            border-radius: 0;
            padding: 5px 8px 6px;
        }
        
        .admin-only {
            display: none;
        }
        
        body {
            margin-bottom: 100px;
        }

    </style>
</head>

<body>
    <div class="nav">
        <a style="line-height: 30.78px;" href="/">Home</a>
        <button id="btn-login" class="btn blue float-right">Sign in</button>
        <span id="profile" class="float-right" style="line-height: 30.78px; margin-right: 1rem; display: none;" href="#">Profile</span>
        <span id="lb-welcome" class="float-right" style="line-height: 30.78px; display: none;">Welcome,&nbsp;</span>
    </div>
    <div class="container">
        <center>
            <p style="color: #555; font-size: 30px; margin-bottom: 26px; line-height: 32px;">Manage your account, all in one place</p>
        </center>
        <div class="panel panel-default">
            <div class="panel-heading">Account Information</div>
            <div class="panel-body">
                <table class="table table-striped">
                    <tr>
                        <th>User Name</th>
                        <th>User Type</th>
                        <th>Max number of books</th>
                        <th>Max number of days</th>
                    </tr>
                    <tr>
                        <td id="user-name">Loading ...</td>
                        <td id="user-type">Loading ...</td>
                        <td id="max-books">Loading ...</td>
                        <td id="max-days" style="white-space: inherit; width: inherit;">Loading ...</td>
                </table>
            </div>
        </div>
        <div class="panel panel-default">
            <div class="panel-heading">My Books</div>
            <div class="panel-body">
                <table id="borrowed-books" class="table table-striped">
                    <tr>
                        <th>Book ID</th>
                        <th>Book Name</th>
                        <th>Date Checked Out</th>
                        <th>Operation</th>
                    </tr>
                </table>
            </div>
        </div>
        <div class="panel panel-default admin-only">
            <div class="panel-heading">User Management</div>
            <div class="panel-body">
                <table id="users" class="table table-striped">
                    <tr>
                        <th>User ID</th>
                        <th>User Name</th>
                        <th>Level</th>
                        <th>Operations</th>
                    </tr>
                </table>
            </div>
        </div>
        <div class="panel panel-default admin-only">
            <div class="panel-heading">Book Management</div>
            <div class="panel-body">
                <table id="all-books" class="table table-striped">
                    <tr>
                        <th>Book ID</th>
                        <th>Book Name</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Operations</th>
                    </tr>
                </table>
            </div>
        </div>
        <div class="panel panel-default admin-only">
            <div class="panel-heading" data-toggle="collapse" data-target="#user-mgmt" style="cursor: pointer;">+ Add User</div>
            <div id="user-mgmt" class="panel-body collapse">
                <div class="form-group">
                    <input id="new-user-id" class="form-control" type="text" placeholder="User ID (Account)">
                </div>
                <div class="form-group">
                    <input id="new-user-name" class="form-control" type="text" placeholder="User Name">
                </div>
                <div class="form-group">
                    <input id="new-user-password" class="form-control" type="password" placeholder="Password">
                </div>
                <div class="form-group">
                    <input id="new-user-type" class="form-control" type="text" placeholder="Level (normal, advanced or admin)">
                </div>
                <button class="btn blue" onclick="addUser();">Add</button>
            </div>
        </div>
        <div class="panel panel-default admin-only">
            <div class="panel-heading" data-toggle="collapse" data-target="#book-mgmt" style="cursor: pointer;">+ Add Book</div>
            <div id="book-mgmt" class="panel-body collapse">
                <div class="form-group">
                    <input id="new-book-name" class="form-control" type="text" placeholder="Book Name">
                </div>
                <div class="form-group">
                    <input id="new-book-type" class="form-control" type="text" placeholder="Type">
                </div>
                <button class="btn blue" onclick="addBook();">Add</button>
            </div>
        </div>
    </div>
    <script>
        $(document).ready(function () {
            $(window).focus(detectCookies);

            detectCookies();

            if ($.hasCookie) {
                getProfile();
                getBooks();

                checkIsAdmin();
            }

            // Events
            $('#btn-login').click(function () {
                if ($.hasCookie) {
                    Cookies.remove('lib-account');
                    window.location.reload();
                } else {
                    window.location.href = 'login';
                }
            });
        });

        function checkIsAdmin() {
            $.ajax({
                method: 'GET',
                url: 'isAdmin',
                timeout: 100000,
                data: {
                    'account': $.account
                },
                success: function (isAdmin) {
                    if (isAdmin) {
                        $('.admin-only').css('display', 'inherit');
                        getAllUsers();
                        getAllBooks();
                    } else {
                        $('.admin-only').addClass('disabled');
                    }
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        function detectCookies() {
            // Cookies
            let account = Cookies.get('lib-account');
            let btnLogin = $('#btn-login');
            let profile = $('#profile');
            let lb_welcome = $('#lb-welcome');
            $.hasCookie = account != undefined;
            $.account = account;
            // Update account info
            if ($.hasCookie) {
                btnLogin.text('Sign out');
                profile.text(account);
                profile.attr('href', 'user');
                profile.css('display', 'inherit');
                lb_welcome.css('display', 'inherit');
            } else {
                btnLogin.text('Sign in');
                profile.css('display', 'none');
                lb_welcome.css('display', 'none');
                window.location.href = 'login';
            }
        }

        // Account Information
        function getProfile() {
            $.ajax({
                method: 'GET',
                url: 'user/' + $.account,
                timeout: 100000,
                success: function (data) {
                    console.log('user profile: ', data);
                    $('#user-name').text(data['userName']);
                    $('#user-type').text(data['userType']);
                    $('#max-books').text(data['maxBooks']);
                    $('#max-days').text(data['maxDays']);
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        // My Books
        function getBooks() {
            $.ajax({
                method: 'GET',
                url: 'user/' + $.account + '/books',
                timeout: 100000,
                success: function (books) {
                    console.log('borrowed books: ', books);
                    let tb_borrowedBooks = $('#borrowed-books');
                    tb_borrowedBooks.children('tbody').children().slice(1).remove();
                    for (book of books) {
                        tb_borrowedBooks.append('<tr><td>' + book['bookId'] + '</td><td>' + book['name'] + '</td><td>' + parseDate(book['borrowedDate']) + '</td><td><button class="lb-btn" onclick="returnBook(\'' + book['bookId'] + '\');">Return</button></td></tr>');
                    }
                    if (books.length == 0) {
                        tb_borrowedBooks.append('<tr><td colspan="4" align="center" style="color: #999;">Nothing more</td></tr>');
                    }
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        function returnBook(bookId) {
            $.ajax({
                method: 'GET',
                url: 'return',
                data: {
                    'bookId': bookId
                },
                timeout: 100000,
                success: function (result) {
                    console.log('return book result: ', result);
                    getBooks();
                    getAllBooks();
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        // User Mgmt
        function getAllUsers() {
            $.ajax({
                method: 'GET',
                url: 'allUsers',
                timeout: 100000,
                success: function (users) {
                    console.log('all users: ', users);
                    let tb_users = $('#users');
                    tb_users.children('tbody').children().slice(1).remove();
                    for (key in users) {
                        if (users.hasOwnProperty(key)) {
                            let user = users[key];
                            tb_users.append('<tr><td>' + user['id'] + '</td><td>' + user['name'] + '</td><td>' + parseUserType(user['userType']) + '</td><td><button class="lb-btn" onclick="upgrade(\'' + user['id'] + '\', \'' + user['userType'] + '\')">Upgrade</button>&nbsp;&nbsp;<button class="lb-btn" onclick="downgrade(\'' + user['id'] + '\', \'' + user['userType'] + '\')">Downgrade</button>&nbsp;&nbsp;<button class="lb-btn" onclick="deleteUser(\'' + user['id'] + '\')"' + isHimself(user['id']) + '>Delete</button></td></tr>');
                        }
                    }
                    if (users.length == 0) {
                        tb_users.append('<tr><td colspan="4" align="center" style="color: #999;">Nothing more</td></tr>');
                    }
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        function upgrade(id, currentLevel) {
            switch (currentLevel.toLowerCase()) {
                case 'normal':
                    changeUserType(id, 'advanced');
                    break;
                case 'advance':
                    changeUserType(id, 'admin');
                    break;
                case 'admin':
                    alert('cannot do this');
                    break;
            }
        }

        function downgrade(id, currentLevel) {
            switch (currentLevel.toLowerCase()) {
                case 'normal':
                    alert('cannot do this');
                    break;
                case 'advance':
                    changeUserType(id, 'normal');
                    break;
                case 'admin':
                    changeUserType(id, 'advanced');
                    break;
            }
        }

        function changeUserType(id, type) {
            $.ajax({
                method: 'GET',
                url: 'changeUserType',
                timeout: 100000,
                data: {
                    'account': id,
                    'userType': type
                },
                success: function (result) {
                    console.log('changeUserType:', result);
                    if (result) {
                        getProfile();
                        getAllUsers();
                        checkIsAdmin();
                    }
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        function deleteUser(id) {
            $.ajax({
                method: 'GET',
                url: 'deleteUser/' + id,
                timeout: 100000,
                success: function (result) {
                    console.log('delete user ' + id + ': ' + result);
                    getAllUsers();
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        // Book Mgmt
        function getAllBooks() {
            $.ajax({
                method: 'GET',
                url: 'allBooks',
                timeout: 100000,
                success: function (books) {
                    console.log('all books: ', books);
                    let tb_allBooks = $('#all-books');
                    tb_allBooks.children('tbody').children().slice(1).remove();
                    for (key in books) {
                        if (books.hasOwnProperty(key)) {
                            let book = books[key];
                            tb_allBooks.append('<tr><td>' + book['bookId'] + '</td><td>' + book['name'] + '</td><td>' + parseBookType(book['bookType']) + '</td><td>' + parseStatus(book['bookStatus']) + '</td><td><button class="lb-btn" onclick="deleteBook(\'' + book['bookId'] + '\');" ' + isDisabled(book['bookStatus']) + '>Delete</button></td></tr>');
                        }
                    }
                    if (books.length == 0) {
                        tb_allBooks.append('<tr><td colspan="4" align="center" style="color: #999;">Nothing more</td></tr>');
                    }
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        function deleteBook(id) {
            $.ajax({
                method: 'GET',
                url: 'deleteBook/' + id,
                timeout: 100000,
                success: function (result) {
                    console.log('delete book ' + id + ': ', result);
                    getAllBooks();
                },
                error: function (e) {
                    console.log('ERROR: ', e);
                }
            });
        }

        // Add User
        function addUser() {
            let id = $('#new-user-id').val();
            let name = $('#new-user-name').val();
            let password = $('#new-user-password').val();
            let type = $('#new-user-type').val();

            if (id && name && password && type) {
                $.ajax({
                    method: 'GET',
                    url: 'addUser',
                    timeout: 100000,
                    data: {
                        'account': id,
                        'userName': name,
                        'password': password,
                        'userType': type
                    },
                    success: function (result) {
                        console.log('add user ' + name + ': ', result);
                        if (result) {
                            getAllUsers();
                            $('#new-user-id').val('');
                            $('#new-user-name').val('');
                            $('#new-user-password').val('');
                            $('#new-user-type').val('');
                        }
                    },
                    error: function (e) {
                        console.log('ERROR: ', e);
                    }
                });
            } else {
                alert('required fields');
            }
        }

        // Add Book
        function addBook() {
            let name = $('#new-book-name').val();
            let type = $('#new-book-type').val();

            if (name && type) {
                $.ajax({
                    method: 'GET',
                    url: 'addBook',
                    timeout: 100000,
                    data: {
                        'bookName': name,
                        'bookType': type
                    },
                    success: function (result) {
                        console.log('add book ' + name + ': ', result);
                        if (result) {
                            getAllBooks();
                            $('#new-book-name').val('');
                            $('#new-book-type').val('');
                        }
                    },
                    error: function (e) {
                        console.log('ERROR: ', e);
                    }
                });
            } else {
                alert('required fields');
            }
        }

        // Util Functions
        function parseDate(localDate) {
            return localDate['year'] + '-' + localDate['monthValue'] + '-' + localDate['dayOfMonth'];
        }

        function parseUserType(type) {
            switch (type) {
                case 'NORMAL':
                    return 'Normal';
                case 'ADVANCE':
                    return 'Advanced';
                case 'ADMIN':
                    return 'Admin';
            }
        }

        function parseBookType(type) {
            switch (type) {
                case 'COMPUTER_SCIENCE':
                    return 'Computer Science';
                default:
                    return type.charAt(0).toUpperCase() + type.slice(1).toLowerCase();
            }
        }

        function parseStatus(status) {
            switch (status) {
                case 'BORROWING_OUT':
                    return '<span style="color: #ea4335;">Checked out</span>';
                default:
                    return '<span style="color: #34a853;">Available</span>';
            }
        }

        function isDisabled(status) {
            switch (status) {
                case 'BORROWING_OUT':
                    return 'disabled';
                default:
                    return '';
            }
        }

        function isHimself(id) {
            if ($.account === id) {
                return 'disabled';
            }
        }

    </script>
</body>

</html>
